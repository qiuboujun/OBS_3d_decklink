name: Windows Build (DeckLink)
on:
  workflow_dispatch:
  push:
    branches:
      - decklink-3d

jobs:
  windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          fetch-tags: true

      - name: Sync submodules
        shell: pwsh
        run: |
          git submodule sync --recursive
          git submodule update --init --force --recursive

      - name: Ensure libdshowcapture
        shell: pwsh
        run: |
          if (-not (Test-Path "deps/libdshowcapture/src/dshowcapture.hpp")) {
            if (Test-Path "deps/libdshowcapture/src") {
              Remove-Item -Recurse -Force "deps/libdshowcapture/src"
            }
            git clone --depth 1 https://github.com/obsproject/libdshowcapture.git "deps/libdshowcapture/src"
          }

      - name: Fetch OBS tags
        shell: pwsh
        run: |
          if (-not (git remote | Select-String -SimpleMatch "upstream")) {
            git remote add upstream https://github.com/obsproject/obs-studio.git
          }
          git fetch --tags upstream

      - name: Ensure version tag
        shell: pwsh
        run: |
          $tag = git tag --points-at HEAD | Select-String -Pattern '^[0-9]+\.[0-9]+\.[0-9]+' | ForEach-Object { $_.Line } | Select-Object -First 1
          if (-not $tag) {
            $tag = git tag --list --sort=-v:refname | Select-String -Pattern '^[0-9]+\.[0-9]+\.[0-9]+' | ForEach-Object { $_.Line } | Select-Object -First 1
            if (-not $tag) { $tag = '30.0.0' }
            git tag -f $tag
          }

      - name: Build OBS (x64)
        uses: ./.github/actions/build-obs
        with:
          target: x64
          config: RelWithDebInfo

      - name: Package OBS
        uses: ./.github/actions/package-obs
        with:
          target: x64
          config: RelWithDebInfo

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: obs-windows-x64
          path: build_x64/obs-studio-*-windows-x64.zip
